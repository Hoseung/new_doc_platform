# HTML Site Navigation and Collapsible TOC

## Overview

This document describes the CSS-only navigation system for multi-page HTML sites generated by the LitePub pipeline. The implementation prioritizes:

1. **No JavaScript dependency** - Core navigation works without JS
2. **Progressive enhancement** - JS can add features but isn't required
3. **Accessibility** - Keyboard navigation via `:focus-within`
4. **Simplicity** - Uses native CSS features without hacks

---

## Design Decision: CSS-Only Navigation

### Background

When implementing the sidebar navigation for multi-page HTML sites, we evaluated two approaches:

| Approach | Pros | Cons |
|----------|------|------|
| **JavaScript SPA** | Dynamic loading, smooth transitions | Requires JS, breaks without it, harder to debug |
| **CSS-only static** | Works everywhere, simpler, faster initial load | No dynamic highlighting, limited interactivity |

### Decision

We chose **CSS-only static navigation** for the base theme because:

1. **Reliability**: Works in all browsers, including with JS disabled
2. **Simplicity**: Easier to maintain and customize
3. **Performance**: No JS bundle, faster page loads
4. **Accessibility**: Native browser behavior for links and focus
5. **Offline-friendly**: Static HTML works without network

JavaScript-enhanced themes (like `sidebar_docs`) remain available for users who want dynamic features.

---

## TOC on All Pages

### Problem

Pandoc's `chunkedhtml` writer generates a TOC only on the index page by default. Chapter pages have empty sidebars, making navigation impossible.

### Solution

Pass `-V toc` to Pandoc to ensure the `$toc$` template variable is true on all pages:

```python
# In html/renderer.py
extra_args.extend([
    "--toc",      # Generate TOC
    "-V", "toc",  # Include TOC on all pages (not just index)
])
```

This makes `$table-of-contents$` available in the template on every page.

---

## Collapsible TOC Sections

### Problem

Large documents have deep TOC hierarchies. Showing all items clutters the sidebar.

### Solution

Use CSS hover/focus to expand nested sections:

```css
/* Hide nested levels by default */
#lp-toc > ul > li > ul {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
}

/* Show on hover or focus */
#lp-toc > ul > li:hover > ul,
#lp-toc > ul > li:focus-within > ul {
  max-height: 2000px;
  transition: max-height 0.3s ease-in;
}
```

### Visual Indicator

Items with children show an arrow that rotates on expand:

```css
/* Arrow indicator for expandable items */
#lp-toc > ul > li:has(> ul) > a::after {
  content: " ▸";
  font-size: 0.7em;
  display: inline-block;
  transition: transform 0.2s;
}

/* Rotate arrow when expanded */
#lp-toc > ul > li:hover:has(> ul) > a::after {
  transform: rotate(90deg);
}
```

### Keyboard Accessibility

The `:focus-within` pseudo-class ensures keyboard users can navigate:

```css
/* Focus triggers expansion (keyboard navigation) */
#lp-toc > ul > li:focus-within > ul {
  max-height: 2000px;
}
```

When a user tabs to a link inside a nested section, the parent expands.

---

## Fixed Sidebar

### Problem

The sidebar should stay visible while scrolling through long content.

### Solution

Use `position: sticky` on the TOC container:

```css
#lp-toc {
  position: sticky;
  top: var(--spacing-lg);  /* Gap from viewport top */
  max-height: calc(100vh - var(--spacing-xl) * 2);
  overflow-y: auto;
}
```

Benefits:
- Sidebar scrolls with page until it reaches the top
- Then "sticks" while content continues scrolling
- Sidebar itself scrolls if TOC is taller than viewport

---

## Split Level Configuration

### RST Heading Levels

For proper chapter splitting, RST documents must use consistent heading hierarchy:

| Level | RST Syntax | HTML |
|-------|------------|------|
| h1 (chapters) | `====` overline + underline | `<h1>` |
| h2 (sections) | `~~~~` underline | `<h2>` |
| h3 (subsections) | `^^^^` underline | `<h3>` |

**Correct Example:**

```rst
============
Introduction
============

This is the chapter content.

Background
~~~~~~~~~~

This is a section.

Details
^^^^^^^

This is a subsection.
```

### Split Level Options

| `--split-level` | Splits At | Use Case |
|-----------------|-----------|----------|
| 1 (default) | h1 headings | One page per chapter |
| 2 | h2 headings | One page per section |
| 3 | h3 headings | One page per subsection |

### Configuration

```python
# Chapter-level splitting (recommended)
config = default_html_site_config(split_level=1)

# Section-level splitting (more pages)
config = default_html_site_config(split_level=2)
```

Or via CLI:

```bash
python build.py --only-site --split-level=1
```

---

## Template Integration

### Base Template Structure

The base template (`themes/base/template.html`) integrates the TOC:

```html
<div class="page-wrapper">
  <aside id="lp-sidebar">
$if(toc)$
    <nav id="lp-toc" role="doc-toc">
      <h2 class="toc-title">$if(toc-title)$$toc-title$$else$Contents$endif$</h2>
      $table-of-contents$
    </nav>
$endif$
  </aside>

  <main id="lp-content">
    $body$
  </main>
</div>
```

### No JavaScript in Base Theme

The base template does not include any `<script>` tags:

```html
<!-- Footer -->
<footer id="lp-footer">
  ...
</footer>

$for(include-after)$
$include-after$
$endfor$

</body>  <!-- No theme.js reference -->
```

JavaScript-enabled themes can add their own `<script>` tags.

---

## CSS Variables for Theming

The collapsible TOC respects theme variables:

```css
:root {
  --spacing-md: 1rem;
  --spacing-lg: 1.5rem;
  --spacing-xl: 2rem;
  --color-text-secondary: #586069;
  --color-link: #0366d6;
}
```

Override these in a custom theme to change behavior:

```css
/* Custom theme overrides */
:root {
  --color-link: #0070f3;  /* Different link color */
}
```

---

## Mobile Responsiveness

### Layout Changes

On narrow screens, the layout switches to stacked:

```css
@media (max-width: 768px) {
  .page-wrapper {
    flex-direction: column;
  }

  #lp-sidebar {
    width: 100%;
    order: 1;  /* After content on mobile */
  }

  #lp-content {
    order: 0;  /* Content first on mobile */
  }

  #lp-toc {
    position: static;  /* No sticky on mobile */
    max-height: none;
  }
}
```

### Collapsible Behavior on Mobile

The hover-based expansion still works on mobile via:
- Touch and hold (triggers `:hover` on mobile)
- Tapping links (triggers `:focus-within`)

---

## Browser Support

The CSS features used have broad support:

| Feature | Support |
|---------|---------|
| `position: sticky` | All modern browsers |
| `:hover`, `:focus-within` | All modern browsers |
| `:has()` selector | Chrome 105+, Firefox 121+, Safari 15.4+ |
| CSS transitions | All modern browsers |

For browsers without `:has()` support, the arrow indicator won't appear but navigation still works.

---

## Comparison with JavaScript Approach

### What CSS-Only Provides

- ✅ Expand/collapse on hover
- ✅ Keyboard navigation via focus
- ✅ Visual expand indicator
- ✅ Smooth transitions
- ✅ Fixed sidebar
- ✅ Works offline

### What Requires JavaScript

- ❌ Highlight current section while scrolling
- ❌ Remember expand/collapse state
- ❌ Smooth scroll to sections
- ❌ "Copy link" buttons
- ❌ Search within TOC

Themes like `sidebar_docs` add these features via JavaScript for users who want them.

---

## Troubleshooting

### TOC Not Appearing on Chapter Pages

**Cause**: Missing `-V toc` in Pandoc options.

**Fix**: Ensure `html/renderer.py` includes:
```python
extra_args.extend(["--toc", "-V", "toc"])
```

### Nested Sections Not Expanding

**Cause**: Missing `:focus-within` support or CSS not loaded.

**Fix**:
1. Check browser supports `:focus-within`
2. Verify `theme.css` is copied to output `assets/` directory

### All Chapters on One Page

**Cause**: RST heading levels not set correctly.

**Fix**: Ensure chapter titles use `====` overline + underline:
```rst
============
Chapter Name
============
```

### Sidebar Cuts Off Content

**Cause**: `max-height` too small in collapsible CSS.

**Fix**: Increase `max-height` values:
```css
#lp-toc > ul > li:hover > ul {
  max-height: 2000px;  /* Increase if needed */
}
```

---

## Future Enhancements

Potential improvements (requiring JavaScript):

1. **Active section tracking**: Highlight current heading as user scrolls
2. **Persistent state**: Remember which sections were expanded
3. **Search**: Filter TOC items as user types
4. **Progress indicator**: Show reading progress in sidebar

These would be implemented in an enhanced theme, not the base theme.
