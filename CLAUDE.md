# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Test Commands

```bash
# Run all tests
uv run pytest test/ -v

# Run a single test file
uv run pytest test/test_validators.py -v

# Run a specific test
uv run pytest test/test_filters.py::TestVisibilityFilter::test_external_removes_internal_only -v

# Run tests with coverage
uv run pytest test/ --cov=src/litepub_norm

# Install dependencies
uv pip install -e ".[dev]"
```

## Architecture Overview

This is a **deterministic, AST-centric documentation pipeline** where:
- Prose is authored in `.md/.rst`
- Quantitative artifacts (tables, figures, metrics) are generated by external analysis code
- All synchronization flows are governed by **semantic IDs + registries**

### Pipeline Stages

```
Authored Source (.md/.rst)
    ↓
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Adapters   │───▶│ Normalizer  │───▶│  Resolver   │───▶│  Validator  │
│             │    │             │    │             │    │             │
│ md → Div    │    │ + Registry  │    │ + Artifacts │    │ Safety +    │
│ rst → Div   │    │ metadata    │    │ payloads    │    │ Contracts   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                               ↓
                                                        ┌─────────────┐
                                                        │   Filters   │
                                                        │             │
                                                        │ Visibility  │
                                                        │ Policy      │
                                                        │ Presentation│
                                                        └─────────────┘
```

### Module Organization

```
src/litepub_norm/
├── adapters/          # Format-specific: md → Div, rst → Div
│   ├── markdown.py    # HTML comment fences → wrapper Divs
│   └── rst.py         # RST directives → wrapper Divs
├── normalizer/        # Core normalization
│   ├── harness.py     # Main entry: normalize_file(), normalize_text()
│   ├── core.py        # AST transformation + placeholder injection
│   └── registry.py    # Normalization registry (semantic ID → metadata)
├── resolver/          # Computed content materialization
│   ├── api.py         # Main entry: resolve(), build_resolution_plan()
│   ├── registry.py    # AARC registry (artifacts + hashes)
│   ├── loaders/       # Load payloads: metric_v1, table_simple_v1, etc.
│   └── emitters/      # Emit Pandoc AST nodes from payloads
├── validator/         # Safety and contract validation
│   ├── document.py    # Post-resolution AST validation
│   ├── pandoc_walk.py # Generic AST walker for complete traversal
│   └── *_v1.py        # Schema-specific validators
└── filters/           # Target-specific document production
    ├── api.py         # Main entry: apply_filters()
    ├── visibility.py  # Remove by visibility level
    ├── policy.py      # Remove by forbidden tags
    ├── metadata_strip.py  # Strip provenance attributes
    └── presentation.py    # PDF/HTML transformations
```

### Key Concepts

1. **Semantic ID**: Stable identifier linking authored prose to computed artifacts (e.g., `tbl.category_counts`)

2. **Two Registries**:
   - **Normalization Registry**: Maps semantic IDs to metadata (role, kind, source, visibility)
   - **AARC Registry**: Maps semantic IDs to artifact files + SHA256 hashes

3. **Wrapper Div**: Pandoc Div with semantic ID and attributes:
   ```json
   {"t": "Div", "c": [["semantic-id", [], [["role", "computed"], ["kind", "table"]]], [...]]}
   ```

4. **Placeholder Tokens**: Inserted during normalization, replaced during resolution:
   - `[[COMPUTED:TABLE]]`, `[[COMPUTED:FIGURE]]`, `[[COMPUTED:METRIC]]`

5. **Monotonic Condensation**: `internal → external → dossier` (downstream only removes content)

### Important Implementation Details

- **Bool-as-number bug**: Always check `isinstance(value, bool)` BEFORE `isinstance(value, int)` since Python's `bool` is a subclass of `int`
- **Pandoc AST**: All operations use raw Pandoc JSON dicts, not panflute or other wrappers
- **Determinism**: All outputs must be reproducible (no timestamps, randomness, or network I/O in filters)

## Key Specs and Documentation

- `spec/architecture.md` - Overall system architecture
- `spec/canonical_model_n_contract.md` - Semantic block contracts
- `spec/ast_invariants.md` - AST structural invariants
- `implementation/01_normalization.md` - Normalization stage docs
- `implementation/02_resolution.md` - Resolution stage docs
- `implementation/03_validation.md` - Validation stage docs
- `implementation/04_filtering.md` - Filter stage docs

## Example Usage

```python
from litepub_norm import normalize_file, resolve, load_registry, Registry
from litepub_norm.filters import apply_filters, BuildContext

# Stage 1: Normalize
norm_registry = Registry.from_file("normalization_registry.json")
normalized_ast = normalize_file("report.md", norm_registry)

# Stage 2: Resolve
aarc_registry = load_registry("aarc_registry.json")
resolved_ast = resolve(normalized_ast, aarc_registry)

# Stage 3-4: Filter (includes validation)
context = BuildContext(build_target="external", render_target="pdf")
filtered_ast, report = apply_filters(resolved_ast, context=context)
```
